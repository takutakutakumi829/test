OpenCVを用いたC++コードによるNetivePluginの作成とUnityへの反映



1.はじめに

	Unityのプラグイン関係への学習とOpenCVを用いた画像処理を行うことへの学習を行う際に学んだ事
	Unity側でOpenCV側の設定を行わずに中身の機能を使用したいと思ったのがきっかけでその際に起こった問題を纏める。


2.実際に行った順序

	1.
	　C++を使用したOpenCVでの手の認識とcascade分類器を使用した顔認識の実装
	2.
	　「1」で作成したOpenCVを利用した機能をdllに移植してネイティブプラグインとして出力
	3.
	　dllを読み込んでUnity側でOpenCVの設定などを用いずに機能だけを利用
	
	このような順序で学習し、実装を行った。


3.導入

	1.C++を利用したOpenCV
		環境構築
		1.
		構成プロパティのインクルード、ライブラリディレクトリにそれぞれOpenCVのパスを通す。
		　
		インクルードディレクトリ: [保存箇所]\[OpenCVのバージョン名]\opencv\build\include
		ライブラリディレクトリ	: [保存箇所]\[OpenCVのバージョン名]\opencv\build\install\x64\vc15\staticlib

		2.
		oepnCVを使用したいファイル内で"opencv2/opencv.hpp"をインクルードする。

		その後"cv::"でopenCV内の関数を使用できるようになる。

	学習順序

		大雑把に作業内容を記述すると
		1.
		　1f内の肌色を抽出
		2.
		　抽出した画像を二値化し、大まかな輪郭を点のベクトルとして取得
		3.
		　取得した点のベクトルをフィルタ処理をかけてより大きな輪郭のみを取得出来るようにする
		4.
		　取得した輪郭から形状の描画や判定等を行う。

		という流れで学習を行った。

	2.dllとして出力
		エクスポートする際、明示的なリンクの際に起こる名前装飾によって
		　動的に名前が割り振られ呼び出し側との関数名が一致せずにエラーが起こるために
		　　[extern"C"__declspec(dllexport)]を用いてC言語の関数として利用する。

		dllとして作成する際、呼び出す側とdll側で作成する言語が異なる場合
		　当然ながら返り値の型が呼び出す側の言語に存在しない可能性があるため、そのことを念頭に置きながら作成した。

		また、

	3.Unity側でdllを呼び出して実装
		構築
			1.
			　呼び出したいUnity側のAssets内に対象のdllファイルを置く
			2.
			　Unity内で[using System.Runtime.InteropServices]を呼び出してDllImportAttributeクラスを呼び出せるようにする
			3.
			　dllの関数を使用したいクラス内で

			　[DllImport("dllファイル名")]
			　private static extern [返り値] [関数名] ()

			　と宣言することでそのクラス内でdllの関数を使用することが出来るようになる。

		概要
			今回はUnity側ではカメラのポインターを用意し
			　そのポインターをdll内のVideoCaptureのCreate関数にアクセスする事で生成し
			　　Updateでdll内の描画関数を呼び出すことでwebカメラを表示し、手の輪郭の生成等を行った。

			※注意点
			　Unityは64ビットバイナリで動作しているため、関数を用意するdll側も64ビットバイナリで出力するのが好ましい。


4.問題

	エラー等の問題点は[3.導入]内の[3.Unity側でdllを呼び出して実装]で発生。
	制作当初はcascade分類器を用いて物体の判定を行い、結果から物体の大まかな位置を検出する予定だった
	　しかしcascadeclassifer内の関数をdll内で呼び出してネイティブプラグインとしてリリースビルドで出力し
	　　Unity側で使用するとエラーメッセージが表示されない形でのランタイムエラーが発生する。


5.原因

	原因としてデバッグビルドで生成したdllを使用してデバッグを行ったところ正常に動作したため
	　リリースビルド時にローカル変数等が最適化される事で吐かれるエラー、またはメモリの秘匿により生成する側と呼び出す側でのメモリの有無が異なるために
	　　本来メモリを持たない側で存在しない物を呼び出そうとしてエラーが吐かれるというものだと考えた。


6.対処

	解決のためにはデバッグビルドで出力したdllを使用する、又はCascadeClassiferを用いずに輪郭を描画する必要があると考えた。
	今回はデバッグビルドだと正常に動作し、webカメラの映像を映す事自体は成功したが、fpsが著しく落ちたため、別の方法で輪郭を描画する事にした。
	　その後、上記の肌色を検出し、フィルタ処理をかけたものに対して描画を行う事で輪郭を取得する形に変更することで対処を行った。


参考元

	[ダイナミック リンク ライブラリ (DLL)]
	https://docs.microsoft.com/ja-jp/troubleshoot/windows-client/deployment/dynamic-link-library

	[OpenCV 2.2 C++ リファレンス]
	http://opencv.jp/opencv-2svn/cpp/

	[C++形式の動的リンク・ライブラリの書き方(msvc編)][ケイロニアン様]
	https://qiita.com/Chironian/items/462a3bdf271d5f0b00b6

	[Unity で OpenCV で作成したテクスチャをネイティブプラグイン経由で利用してみた][凹様]
	http://tips.hecomi.com/entry/2014/01/16/011727

	[UnityでOpenCVを Native Plugin にして利用する (Windows)][いづみはら あつし様]
	http://izmiz.hateblo.jp/entry/2014/12/12/222636

	[Hand 検出について調査中][nonbiri15様]
	https://qiita.com/nonbiri15/items/6abaade346512fcb8c92


使用環境

	VisualStudio
		2019 Version 16.8.3

 	OpenCV
 		4.1.1

 	Unity
 		2019.4.9f1
